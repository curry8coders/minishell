# テストスイート改善提案レポート

`test/test.sh` の分析において見つかった、修正や改善が推奨される点をまとめました。
これらは現在のテストの信頼性を向上させ、より厳密な検証を行うためのものです。

## 1. 標準エラー出力 (stderr) の検証

*   **現状**: `bash >"$TMP_DIR/cmp" 2>&-` のように、標準エラー出力が閉じられています。
*   **問題点**: エラーメッセージ（例: `command not found` や `syntax error`）が正しく出力されているか、あるいは余計なエラーが出ていないかが検証されていません。
*   **改善案**: 標準エラー出力もファイルにリダイレクトし、`diff` で比較するように修正すべきです。
    ```bash
    # 例
    ... | bash >"$TMP_DIR/cmp" 2>"$TMP_DIR/cmp.err"
    ... | ./minishell >"$TMP_DIR/out" 2>"$TMP_DIR/out.err"
    diff "$TMP_DIR/cmp.err" "$TMP_DIR/out.err"
    ```
    ※ ただし、bashとminishellでエラーメッセージのフォーマットが完全に一致しない場合は、完全一致ではなく「エラーが出ていること」の確認に留めるなどの工夫が必要です。

## 2. 差分の詳細表示

*   **現状**: `diff ... >/dev/null` としており、差分がある場合も単に `NG` と表示されるだけです。
*   **問題点**: テストが失敗した際、何が違ったのか（出力が足りないのか、余計な空白があるのかなど）が即座に分かりません。
*   **改善案**: `NG` の場合に `diff` の結果を表示するか、失敗したテストケースの期待値と実際の出力を表示するオプションを追加するとデバッグが容易になります。

## 3. シグナルテストの安定性

*   **現状**: `sleep 0.01` を挟んで `pkill` を実行しています。
*   **問題点**: システムの負荷状況によっては `0.01` 秒では短すぎて、プロセスがシグナルを受け取る前に終了してしまったり、逆に起動する前にシグナルを送ってしまったりする可能性があります（Flaky test）。
*   **改善案**: 可能な限りプロセスID (PID) を特定してシグナルを送るか、もう少し余裕を持った待機時間を設定することが望ましいです。

## 4. 環境依存の排除

*   **現状**: `echo -e` を使用しています。
*   **問題点**: POSIX準拠ではないため、シェルによっては動作が異なる可能性があります。
*   **改善案**: `printf` を使用することで、より移植性の高いテスト記述が可能になります。

## 5. カバレッジの拡大

*   **現状**: 基本的な機能は網羅されていますが、エッジケースが不足している可能性があります。
*   **追加推奨ケース**:
    *   環境変数の展開における境界値（存在しない変数、空文字、特殊文字を含む変数）。
    *   リダイレクトのエラー系（権限がないファイルへの書き込み、存在しないファイルからの読み込み）。
    *   パイプラインの終了ステータス（`pipefail` の挙動など、もし実装しているなら）。
    *   非常に長いコマンドラインや引数。
